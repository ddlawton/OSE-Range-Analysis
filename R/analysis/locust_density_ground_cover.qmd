---
title: "2021 Locust x ground Cover"
format: html
toc: true
---

```{r package loading}
#| echo: false
#| results: "hide"
#| message: false
#| warning: false


library(tidyverse)
library(rnaturalearth)
library(rnaturalearthhires)
library(janitor)
library(here)
library(patchwork)
library(ggpubr)
library(gt)
library(glmmTMB)
library(mgcv)
library(gratia)
library(emmeans)

here::i_am('README.md')

# setting project root
# sourcing functions
source(('R/functions/data_preprocessing.R'), local = knitr::knit_global())
source(('R/functions/table_variable_summary.R'), local = knitr::knit_global())
source(('R/functions/senegal_map.R'), local = knitr::knit_global())
source(('R/functions/locust_density_modeling.R'), local = knitr::knit_global())

```

```{r data loading and processing}
#| echo: false
#| message: false
#| warning: false

data = process_senegal_data('data/raw/Toure_OSE2021data_v03.xlsx')

```

We would like to see how density is influenced by ground cover. To do this I am building a generalized additive model (family: tweedie). Following this form:

The generalized additive model (GAM) fitted is:

$$
\begin{align*}
\text{ose\_count}_i = \\
  &\alpha + \\ 
  &+ f(\text{percent\_ground\_cover}_i,\, \text{region\_treat}_i) +  \\
  &+ b_{\text{farmer}_i} + \\
  &+ \varepsilon_i
\end{align*}
$$

where:

-   $\alpha$ is the intercept,
-   $f(\text{percent\_ground\_cover},\, \text{region\_treat})$ is a smooth function (tensor product, using factor-smooth interaction) over percent ground cover and region treatment,
-   $b_{\text{farmer}_i}$ is a random effect for each farmer,
-   $\varepsilon_i$ is the residual error.

```{r constructing gam model}
#| echo: false
#| message: false
#| warning: false


ground_cover_dat <- data |>
    dplyr::select(region,farmer,fertilizer_treatment,mission_number,ose_count,percent_ground_cover) |>
    mutate(
        region_treat = factor(paste0(region,'_',fertilizer_treatment))
    ) |>
    drop_na(ose_count,fertilizer_treatment)

ground_cover_mod <- build_gam(ground_cover_dat,
    formula = ose_count ~ te(percent_ground_cover, region_treat, bs='fs', k=10) + s(farmer, bs='re'),
    nthreads = 9,
    family = mgcv::tw(),
    k = 10) 

```

The model diagnostics look pretty good! I tried to build a poisson model, but the data was overdispersed. Instead I went with a tweedie model which does a pretty good job at handling this type of data:

```{r gam model diagnostics}
#| echo: false
#| message: false
#| warning: false


appraise(ground_cover_mod)
```

However, I am not able to reproduce the smooths seen in the manuscript sent to me. This is likely due to data differences as I am not sure what was included in the initial modeling approach. **Roughly** we can see similiar trends in Kaffrine, Fatick, and Saint Louis. But Thies definitely has a different trend. Additionally, there seems to be different trends between control and fertilized treatments as comapred to the current plots in the manuscript. Not sure what to think here.

```{r plotting gam model results}
#| echo: false
#| message: false
#| warning: false

gam_plot <- plot_gam_smooths_gratia(ground_cover_mod)

gam_plot
```

## GAM model summary

```{r}
#| echo: false
#| message: false
#| warning: false


broom.mixed::tidy(ground_cover_mod) |>
  gt() |>
  fmt_number(
    columns = c(edf, ref.df, statistic, p.value),
    decimals = 2
  ) |>
  cols_label(
    term = "Term",
    edf = "Estimated DF",
    ref.df = "Reference DF",
    statistic = "F Statistic",
    p.value = "P-value"
  ) |>
  tab_header(
    title = "GAM model Summary: OSE Density x ground Cover"
  ) |>
  tab_options(
    table.font.size = "small",
    row.striping.background_color = "#F6F6EF"
  ) |>
  as_raw_html()


```